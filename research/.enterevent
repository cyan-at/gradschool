#!/bin/bash -l

<<setup
2022-08-16 14:00:55.274410: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:354] MLIR V1 optimization pass is not enabled

# Install the script to ~/miniforge
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O miniforge.sh
bash miniforge.sh -b -p $HOME/miniforge

# To activate and use Miniconda
source $HOME/miniforge/bin/activate

conda create --name tf python=3.9
conda activate tf

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/
mkdir -p $CONDA_PREFIX/etc/conda/activate.d
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/' > $CONDA_PREFIX/etc/conda/activate.d/env_vars.sh

pip3 install tensorflow --target=/home/cyan3/miniforge/envs/tf/lib/python3.9/site-packages

pip install geomloss pot --target=/home/cyan3/miniforge/envs/tf/lib/python3.9/site-packages

(tf) cyan3@scorpius:/usr/local/home/cyan3/Dev/jim/gradschool/231/research$ python3 -c "import tensorflow as tf; print(tf.reduce_sum(tf.random.normal([1000, 1000])))"
2022-08-16 18:28:34.600557: I tensorflow/core/util/util.cc:169] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2022-08-16 18:28:35.400232: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.403662: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.403901: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.404315: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-08-16 18:28:35.405086: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.405325: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.405536: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.699174: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.699410: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.699599: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:35.699786: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1532] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 1684 MB memory:  -> device: 0, name: NVIDIA RTX A2000 Laptop GPU, pci bus id: 0000:01:00.0, compute capability: 8.6
tf.Tensor(697.80804, shape=(), dtype=float32)
(tf) cyan3@scorpius:/usr/local/home/cyan3/Dev/jim/gradschool/231/research$ python3 -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"
2022-08-16 18:28:44.062975: I tensorflow/core/util/util.cc:169] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2022-08-16 18:28:44.776287: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:44.780290: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2022-08-16 18:28:44.780529: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:975] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
[PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]

-------------------

for vipersim01

# clean up any prior
conda remove pytorch

# get a libdevice for some 11.6 version
locate libdevice.10.bc
conda install cudatoolkit=11.6 
locate libdevice.10.bc

# link /usr/local/home/cyan3/miniforge/envs/tf/nvvm/libdevice/libdevice.10.bc to 11.6

  mv /usr/local/home/cyan3/miniforge/envs/tf/nvvm/libdevice/libdevice.10.bc /usr/local/home/cyan3/miniforge/envs/tf/nvvm/libdevice/libdevice.10.bc.backup
  cd /usr/local/home/cyan3/miniforge/envs/tf/nvvm/libdevice/
  ln -s ~/miniforge/pkgs/cudatoolkit-11.6.0-hecad31d_10/lib/libdevice.10.bc .

# now install onednn
conda install -c conda-forge onednn (2.6.1)

torch for 11.6
pip3 install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu116
conda install pytorch torchvision torchaudio cudatoolkit=11.6 -c pytorch -c conda-forge

###############################

conda install -c conda-forge cudatoolkit=11.6 cudnn onednn ipython
cd /usr/local/home/cyan3/miniforge/envs/tf/
ls
mkdir -p nvvm/libdevice/
cd nvvm/libdevice/
ls
ln -s ~/miniforge/pkgs/cudatoolkit-11.6.0-hecad31d_10/lib/libdevice.10.bc .
pip3 install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu116
pip install deepxde cvxpy cvxpylayers jupyterlab ipdb argparse

###############################

pip install tensorflow tensorflow-gpu

scp cyan3@vipersim01:/home/cyan3/miniforge/envs/tf/lib/python3.9/site-packages/deepxde/data/pde.py /home/cyan3/miniforge/envs/tf/lib/python3.9/site-packages/deepxde/data/pde.py

scp model.py cyan3@vipersim04.ndc.nasa.gov:~/miniforge/envs/tf/lib/python3.9/site-packages/deepxde/model.py

julia:

julia
using PyCall
using PDMats
using Primes
using Distributions
using LinearAlgebra
using Parameters

######################################

conda env create -f environment.yml
conda install pytorch=1.12.1 torchsde=0.2.4

######################################

if you run into 
https://stackoverflow.com/questions/48453497/anaconda-libstdc-so-6-version-glibcxx-3-4-20-not-found
https://github.com/rstudio/reticulate/issues/1282

locate libstdc++.so.6
strings /usr/local/home/cyan3/miniforge/lib/libstdc++.so.6.0.30 | grep GLIBCXX
strings /usr/local/home/cyan3/miniforge/lib/libstdc++.so.6.0.30 | grep GLIBCXX | grep 3.4.30
echo $LD_LIBRARY_PATH 
echo $LD_LIBRARY_PATH | grep miniforge
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/home/cyan3/miniforge/lib/


######################################

works on vs04 / vs09 for adding torchsde:

it is now conda-forge/linux-64::cudatoolkit-11.6.0-hecad31d_11, not _10 anymore

conda remove pytorch cudatoolkit

cd /usr/local/home/cyan3/miniforge/envs/tf/nvvm/libdevice/
ln -s ~/miniforge/pkgs/cudatoolkit-11.6.0-hecad31d_11/lib/libdevice.10.bc .

conda install cudnn onednn -c conda-forge
conda install torchsde=0.2.4=py39h1a9c180_3 cudatoolkit=11.6=hecad31d_11 pytorch=1.12.1=cuda112py39hb0b7ed5_201

######################################

a faster way to get vs06 to support torchsde

conda config --add channels pytorch
conda install -c conda-forge pytorch pytorch=1.12.1=py3.9_cuda11.6_cudnn8.3.2_0 torchsde=0.2.4=py39h1a9c180_3

conda install -c conda-forge pytorch pytorch=1.12.1=cuda112py39hb0b7ed5_201 torchsde=0.2.4.=py39h1a9c180_3

conda install pyqtgraph pyqt pyopengl
setup

echo "hello, starting tf conda"

echo "unsetting PYTHONPATH to not confuse conda"
unset PYTHONPATH

echo "loading conda, doing what source /miniforge/bin/activate inside .enterevent"
# source ~/miniforge/bin/activate
# below is how you run equivalent of above 'source' inside .enterevent
_CONDA_ROOT="/home/cyan3/miniforge"
. "$_CONDA_ROOT/etc/profile.d/conda.sh" || return $?
# conda activate "$@"
conda activate ""

echo "loading tf environment for tensorflow"
conda activate tf

echo "adding miniforge to LD_LIBRARY_PATH"
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/home/cyan3/miniforge/lib/